---
lab:
    title: '13: Azure Logic Apps と Azure Event Grid の統合を実装する'
    module: 'モジュール 13: アプリケーション アーキテクチャの設計'
---

# ラボ: Azure Logic Apps と Azure Event Grid の統合を実装する
# 受講生用ラボ マニュアル

## ラボ シナリオ
Adatum 社には、エージェントベース ソリューションと、エージェントレス ソリューションの組み合わせを利用して、環境の変化を可視化する、広範なオンプレミス ネットワーク監視フレームワークがあります。エージェントレス ソリューションは、状態の変化を判断するためにポーリングに依存しているため、比較的に非効率的な傾向があります。 

Adatum はワークロードの一部を Azure に移行する準備をしているため、Enterprise Architecture チームは、これらの非効率性に対処し、クラウドで利用可能なイベント駆動型アーキテクチャの使用を評価したいと考えています。ソリューションまたはアプリケーションでイベントを使用するという概念は、チームにとって新しいものではありません。実際、彼らは開発者と共にイベント駆動型プログラミングのアイデアを推進してきました。イベント駆動型アーキテクチャの中心的な原則の 1 つは、既存のサービスの相互依存関係を逆にすることです。Azure は、パブリッシャー/サブスクライバー モデルを利用してイベントのルーティングをサポートする完全に管理されたサービスである Event Grid に依存することにより、この機能を提供します。根本的に、Event Grid は、多数のソースおよびサブスクライバーからのイベントのルーティングと配信を管理するイベント ルーティング サービスです。

イベントは、Blob ストレージ アカウント、Azure リソース グループ、または Azure サブスクリプションなどのパブリッシャーによって作成されます。イベントが発生すると、それらは Event Grid サービスがすべての着信メッセージをダイジェストするために管理する、トピックと呼ばれるエンドポイントに公開されます。イベント パブリッシャーは、Azure 上のサービスに限定されません。どこからでも実行できるカスタム アプリケーション、またはシステムから発生したイベントを使用できます。これには、オンプレミス、データセンター、または他のクラウドでホストされているアプリケーションが含まれ、HTTP リクエストを Event Grid サービスにポストできる場合に限ります。

イベント ハンドラーには、Functions、Logic Apps、Azure Automation などのサーバーレス テクノロジーを含む、いくつかの Azure サービスが含まれます。ハンドラーは、イベント サブスクリプションを作成することにより、Event Grid に登録されます。イベント ハンドラー エンドポイントがパブリックからアクセス可能であり、トランスポート層セキュリティで暗号化されている場合、メッセージを Event Grid からエンドポイントに送信できます。

他の多くの Azure サービスとは異なり、プロビジョニングまたは管理する必要のある Event Grid の名前空間はありません。カスタム トピックはアドホックにプロビジョニングされ、リソース グループに存在する一方で、ネイティブ Azure リソースのトピックは組み込みで、ユーザーに対して完全に透過的です。イベント サブスクリプションは、単にトピックに関連付けられています。このモデルは、サブスクリプションとしてのトピックの管理を簡素化し、Event Grid を高度なマルチテナントにして、大規模なスケールアウトを可能にします。

Azure Event Grid は、いかなる言語やプラットフォームに依存しません。これは Azure サービスとネイティブに統合されますが、HTTP プロトコルをサポートするものなら何でも簡単に活用できるため、非常に賢く革新的なサービスになります。

この機能を調査するために、Adatum アーキテクチャ チームは、Azure Logic Apps と Event Grid の統合をテストして、次のことを行います。

-  指定された Azure VM の状態が変更されたときに検出する

-  イベントに応答して電子メールによる通知を自動的に生成する


## 目標
  
このラボを完了すると、次のことができるようになります。

-  Event Grid を使用して Azure Logic Apps を統合する

-  リソース グループ内のリソースへの変更を表すイベントに応答して、Logic Apps の実行をトリガーする


## ラボ環境
  
Windows Server 管理者の資格情報

-  User Name (ユーザー名): **Student**

-  パスワード: **Pa55w.rd1234**

推定時間: 60 分


## ラボ ファイル

-  \\\\AZ304\\AllFiles\\Labs\\04\\azuredeploy30304suba.json

-  \\\\AZ304\\AllFiles\\Labs\\04\\azuredeploy30304rga.json

-  \\\\AZ304\\AllFiles\\Labs\\04\\azuredeploy30304rga.parameters.json

## 説明

### 演習 0: ラボ環境の準備

この演習の主なタスクは次のとおりです。

 1. Azure Resource Manager テンプレートを使用して Azure VM をデプロイする


#### タスク 1: Azure Resource Manager テンプレートを使用して Azure VM をデプロイする

1. ラボのコンピューターから Web ブラウザーを起動し、 [Azure portal](https://portal.azure.com) に移動し、このラボで使用するサブスクリプションの所有者の役割を持つユーザーアカウントの認証情報を提供してサインインします。

1. Azure で、検索テキストボックスのすぐ右にあるツールバーアイコンを選択して、**Cloud Shell** ペインを表示します。

1. **Bash** や **PowerShell** のどちらかを選択するためのプロンプトが表示されたら、**PowerShell** を選択します。 

    > **注**: **Cloud Shell** を初めて起動し、「**ストレージがマウントされていません**」というメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、「**ストレージの作成**」を選択します。 

1. Cloud Shell ペインから、次の操作を実行して、サブスクリプションに **Microsoft.EventGrid** プロバイダーを登録します。

   ```powershell
   Register-AzResourceProvider -ProviderNamespace 'Microsoft.EventGrid'
   ```

1. Cloud Shell ペインのツールバーで、 **ファイルのアップロード/ダウンロード** アイコンを選択し、ドロップダウン メニューで **アップロード**を選択して、ファイル  **\\\\\AZ304\\AllFiles\Labs\\04\\azuredeploy30304suba.json** を Cloud Shell ホーム ディレクトリにアップロードします。

1. Cloud Shell ペインから次のコマンドを実行してリソースグループを作成します（ `<Azure region>`プレースホルダーを、サブスクリプションでの Azure VM のデプロイに使用可能で、ラボのコンピューターの場所に最も近い Azure リージョンの名前に置き換えます ）:

   ```powershell
   $location = '<Azure region>'
   New-AzSubscriptionDeployment `
     -Location $location `
     -Name az30304subaDeployment `
     -TemplateFile $HOME/azuredeploy30304suba.json `
     -rgLocation $location `
     -rgName 'az30304a-labRG'
   ```

      > **注記**: Azure VM をプロビジョニングできる Azure リージョンを識別するには、[**https://azure.microsoft.com/ja-jp/regions/offers/**](https://azure.microsoft.com/ja-jp/regions/offers/) を参照してください。

1. Cloud Shell ペインから、Azure Resource Manager テンプレート **\\\\AZ304\\AllFiles\Labs\\04\\azuredeploy30304rga.json** をアップロードします。

1. Cloud Shell ペインから、Azure Resource Manager パラメーター ファイル **\\\\ AZ304 \\ AllFilesLabs \\ 04 \\ azuredeploy30304rga.parameters.json** をアップロードします 。

1. Cloud Shell ペインから次を実行して、このラボで使用する Windows Server 2019 を実行する Azure VM をデプロイします:

   ```powershell
   New-AzResourceGroupDeployment `
     -Name az30304rgaDeployment `
     -ResourceGroupName 'az30304a-labRG' `
     -TemplateFile $HOME/azuredeploy30304rga.json `
     -TemplateParameterFile $HOME/azuredeploy30304rga.parameters.json `
     -AsJob
   ```

    > **注**: デプロイが完了するのを待たず、代わりに次の演習に進みます。デプロイにかかる時間は 5 分未満です。

1. Azure portal で、**Cloud Shell** ウィンドウを閉じます。 


### 演習 1: Azure ロジック アプリの認証および許可を構成する

1. Azure Active Directory のサービス プリンシパルを作成する

1. 閲覧者ロールを Azure AD サービス原則に割り当てます 


#### タスク 1: Azure Active Directory のサービス プリンシパルを作成する

1. Azure portal 内の **「Cloud Shell」** で **PowerShell** セッションを開始します。 

1. 「Cloud Shell」ペインから、次の手順を実行して、このタスクの後続の手順に作成するサービス原則に関連付ける新しい Azure AD アプリケーションを作成します。

   ```powershell
   $password = 'Pa55w.rd1234.@z304'
   $securePassword = ConvertTo-SecureString -Force -AsPlainText -String $password
   $az30304aadapp = New-AzADApplication -DisplayName 'az30304aadsp' -HomePage 'http://az30304aadsp' -IdentifierUris 'http://az30304aadsp' -Password $securePassword
   ```

1. Cloud Shell ペインから、次の手順を実行して、前の手順に作成したアプリケーションに関連付けられた新しい Azure AD サービス原則を作成します。

   ```powershell
   New-AzADServicePrincipal -ApplicationId $az30304aadapp.ApplicationId.Guid -SkipAssignment
   ```

1. **New-AzADServicePrincipal** コマンドの出力に、**ApplicationId**プロパティの値をメモ します。これついては、演習の後半で取り上げます。

1. Cloud Shell ペインから、次の操作を実行して、 現在の Azure サブスクリプションの **Id** プロパティの値と、 そのサブスクリプションに関連付けられている Azure AD テナントの **TenantId** プロパティの値を識別します (このラボの次の演習にも必要になります):

   ```powershell
   Get-AzSubscription
   ```

1. 「Cloud Shell」 ペインを閉じます。


#### タスク 2: Azure AD サービス プリンシパルへのアクセスを承認する 

1. Azure portal で、**リソースグループ** を検索して選択します。そして、 **リソース グループ** ブレードで、**az30304a-labRG** を選択します。

1. **az30304a-LabRG** ブレードに、**Access Control (IAM)** を選択します。

1. **az30304a-labRG** で **| 「アクセス制御 (IAM)」** ブレードで、**「+ 追加」** を選択し、**「ロールの割り当てを追加」** を選択します。 

1. **「ロール割り当ての追加」** ブレードで、次の設定を指定し、**「保存」** を選択します。

    | 設定 | 値 | 
    | --- | --- |
    | Role | **閲覧者** |
    | アクセスの割り当て | **ユーザー、グループ、またはサービス プリンシパル** |
    | OK | **az30304aadsp** |


### 演習 2: Azure ロジック アプリの実装
  
この演習の主なタスクは次のとおりです。

1. Azure ロジック アプリを作成します

1. Azure ロジック アプリにトリガーを追加します

1. Azure ロジック アプリに条件を追加します

1. Azure ロジック アプリにアクションを追加します


#### タスク 1: Azure ロジック アプリを作成します

1. Azure portal で、**ロジック アプリ**を検索して選択し、「**Logic Apps**」 ブレードで、「**+ 追加**」 を選択し、「**消費**」 を選択します。

1. **「ロジック アプリ」** ブレードの **「基本」** タブで、次の設定を指定します (他の設定は既定値のままにします)。

    | 設定 | 値 | 
    | --- | --- |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | リソース グループ | 新しいリソース グループ **az30304b-LabRG** の名前 |
    | ロジック アプリ名 | **az30304b-logicapp1** | 
    | 場所の選択 | **リージョン** |
    | 場所 | 前回の演習で選択した Azure リージョンの名前 |
    | ログ分析 | **オフ** |

1. **「確認および作成」** を選択し、次に **「作成」** を選択します。 

    > **注**: ロジック アプリが作成されるまで待ちます。プロビジョニングには約 2 分かかります。 


#### タスク 2: Azure ロジック アプリにトリガーを追加します

1. Azure portal で、**ロジックアプリ** を検索して選択します。 そして、 **Logic Apps** ブレードで、**az30304b-logicapp1** を選択します。

1. 「**ロジック アプリ デザイナー**」 ブレードで、「**空のロジック アプリ**」 を選択します。これにより、空のデザイナー ワークスペースが表示されます。

1. 「**コネクタとトリガーの検索**」テキスト ボックスを使用して **Event Grid** を検索し、結果の一覧の 「**トリガー**」 列で、「**リソース イベントが発生したとき**」 Azure Event Gridトリガーを選択して、デザイナー ワークスペースに追加します。

1. 「**Azure Event Grid**」 タイルに、「**サービス プリンシパルとの接続**」 リンクを選択し、次の設定を指定して、「**作成**」 を選択します。

    | 設定 | 値 | 
    | --- | --- |
    | 接続名 | **az30304egconnection** |
    | クライアント ID | この演習の前半で特定した 「**ApplicationId**」 プロパティの値 |
    | クライアント シークレット | **Pa55w.rd1234.@z304** |
    | Tenant | この演習の前半で特定した 「**TenantId**」 プロパティの値 |

1. **リソース イベントが発生したとき**タイルに、次の値を指定します。

    | 設定 | 値 | 
    | --- | --- |
    | 定期売買 | ドロップダウン リストからサブスクリプションを選択します |
    | リソースの種類 | **Microsoft.Resources.resourceGroups** |
    | リソース名 | **az30304a-labRG** |
    | イベント タイプ アイテム - 1:  | **Microsoft.Resources.ResourceWriteSuccess** |
    | イベント タイプ アイテム - 2:  | **Microsoft.Resources.ResourceDeleteSuccess** |

1. **リソースイベントが発生したとき** タイルで、**新しいパラメーターを追加** を選択し、**サブスクリプション名**を選択します。

1. **サブスクリプション名** テキスト ボックスで、**event-subscription-az30304b** を入力し、**保存**を選択します。


#### タスク 3: Azure ロジック アプリに条件を追加します

1. Azure portal に、新しくプロビジョニングされた Azure ロジック アプリのロジック アプリ デザイナー ブレードに **+ 新しい手順** を選択します。 

1. アクション タイルの選択で、 **コネクタとトリガーを検索** テキストボックスを使用し、**条件**を検索し、結果のリストの**アクション**列で**条件**を選択してデザイナー ワークスペースに追加します。

1. 「**条件**」 タイルの右上隅にある省略記号を選択し、ポップアップ メニューで、「**名前の変更**」 を選択し、**リソース グループの仮想マシンが変更された場合は**、「**条件**」 をテキストに置き換えます。 

1. 条件の左側の 「**値の選択**」 テキスト ボックスを選択し、ポップ アップ ウィンドウ、および 「**式**」 タブで、この式を入力し、「**OK**」 を選択します。

   ```
   triggerBody()?['data']['operationName']
   ```

1. **「と等しい」** が条件の中央要素に表示されていることを確認し、右側の 「**値の選択**」 テキスト ボックスに、監視する操作を表す値を入力します。

   ```
   Microsoft.Compute/virtualMachines/write
   ```

1. 「**Logic Apps デザイナー**」 ブレードで、「**保存**」 を選択します。 


#### タスク 4: Azure ロジック アプリにアクションを追加します

1. Azure portal に、新しくプロビジョニングされた Azure ロジック アプリの 「Logic App デザイナー」 ブレードの、**True** タイルで、「**アクションの追加**」 を選択します。 

1. **アクションを選択** ウィンドウに、**検索コネクタとアクション** テキスト ボックスに**Outlook**と入力します。

1. 結果の一覧で、**Outlook.com** を選択します。 

1. **Outlook.com** のアクションの一覧で、「**メールの送信 (V2)**」 を選択します。

1. 「**Outlook.com**」 ウィンドウで、「**サインイン**」 を選択します。 

1. プロンプトが表示された場合は、このラボに使用している Microsoft アカウントを使用して認証します。 

1. Outlook リソースにアクセスするための Azure ロジック アプリ アクセス許可を付与する同意を求めるメッセージが表示された場合は、「**はい**」 を選択します。

1. 「**Outlook.com**」 ウィンドウで、「**メールの送信 (V2)**」 タイルの右上隅にある省略記号を選択し、ポップアップ メニューで、「**名前の変更**」、および 「**メールの送信 (V2)**」 を 「**メールを送信**」 というテキストに置き換えます。 

1. 「**メールを送信**」 ウィンドウに、次の設定を指定し、「**保存**」 を選択します。

    | 設定 | 値 | 
    | --- | --- |
    | To | Microsoft アカウントの通常の電子メール アドレス |
    | 件名 | 「**リソース更新:**」を入力して、「**メールを送信**」 ウィンドウの右側にある 「**動的なコンテンツ**」 列で、「**件名**」 を選択します。 |
    | Body | **リソース グループ:** と入力し、**「メールを送信」** ペインの右側の **「動的コンテンツ」** 列の下にある検索テキストボックスで、**「トピック」** を入力して選択し、**「ボディ」** テキスト ボックスに戻り、新しい行に **イベント タイプ:** と入力します。**「メールを送信」** ペインの右側の **「動的コンテンツ」** 列の下にある検索テキスト ボックスで、**イベント タイプ:** を入力して選択し、**「ボディ」** テキスト ボックスに戻り、新しい行に **イベントID:** と入力します。**「メールの送信」** の右側にある **「動的コンテンツ」** 列の下にある検索テキスト ボックスで、**ID** を入力して選択し、**「ボディ」** テキストボックスに戻り、新しい行に **イベント時間:** を入力します。下の検索テキスト ボックス **「メールを送信」** の右側にある **「動的コンテンツ」** 列の下にある検索テキスト ボックスで、**イベント時間** を入力して選択します。 |

    **メールボックスに入り、電話番号を入力して、アカウントを確認する必要がある場合があります。**

1. 「**Logic Apps デザイナー**」 ブレードで、「**保存**」 を選択します。 


### 演習 3: イベント サブスクリプションの導入
  
この演習の主なタスクは次のとおりです。

1. イベント サブスクリプションを構成する

1. Azure ロジック アプリの機能を確認する

1. ラボにデプロイした Azure リソースを削除する


#### タスク 1: イベント サブスクリプションを構成する

1. Azure portal で、**「az30304b-logicapp1」** ブレードに移動し、**「概要」** セクションで、**「トリガー履歴」** を選択します。 

1. **When_a_resource_event_occurs** ブレードに、**コールバック URL 「POST」** テキスト ボックスの値をコピーします。

1. Azure portal に **az30304a-LabRG** リソース グループに移動し、垂直メニューに **イベント**をクリックします。

1. **az30304a-LabRG** で **| 「イベント」** ブレードで、**「+ イベント サブスクリプション」** を選択します。

1. **「イベント サブスクリプションの作成」** ブレードで、次の設定を指定し、**「作成」** を選択します。

    | 設定 | 値 | 
    | --- | --- |
    | 名前 | **event-subscription-az30304a-LabRG** |
    | イベント スキーマ | **Event Grid Schema** |
    | システム トピック名 | **az30304b-eventgridtopic** |
    | イベントの種類のフィルター | **リソース書き込み成功**、**リソース削除成功**、**リソースアクション成功** |
    | エンドポイントの種類 | **webhook** | 
    | エンドポイント | このタスクの最初にコピーした URL 文字列 |

1. **「作成」** を選択します。


#### タスク 2: Azure ロジック アプリの機能を確認する

1. Azure portal で、**az30304a-labRG** リソース グループ、およびリソースのリストで、**az30304a-vm0** Azure VM を表すエントリを選択します。

1. 「**az30304a-vm0**」 ブレードの、「**設定**」 セクションで、「**サイズ**」 を選択します。

1. **az30304a-vm0** で **|** 「**サイズ**」 ブレード、現在設定されているものとは異なるサイズを選択して、「**サイズ変更**」 を選択し、サイズ変更操作が正常に完了したことを確認します。 

1. 「**az30304b-logicapp1**」 ブレードに戻り、「**最新の情報に更新**」 を選択します。「**実行の履歴**」 には Azure VM の状態の変化に対応するエントリが含まれていることに注意してください。

1. **実行の履歴**リストから、Azure VM での正常なサイズ変更を表す、最も長い期間を持つエントリを選択します。

1. 「**ロジック アプリの実行**」 ブレードで、ロジック アプリ実行のワークフローを表す図を確認します。

1. 「**ロジック アプリの実行**」 ブレードで、「**リソース イベントが発生したとき**」 を選択して長方形を展開し、「**出力**」 セクションで、「**未加工出力の表示**」 を選択します。

1. 「**出力**」 ブレードで、イベントの詳細を確認し、ユーザー アカウントの ID や、Azure VM のサイズ変更のリクエスト元の IP アドレスなどの詳細が含まれていることに注意してください。 


1. 前の演習に構成したメール アカウントの受信トレイに移動し、ロジック アプリによって生成されたメールが含まれていることを確認します。


#### タスク 3: ラボにデプロイした Azure リソースを削除する

1. 「Cloud Shell」 ウィンドウから次のコマンドを実行して、この演習で作成したリソース グループを一覧表示します。

   ```powershell
   Get-AzResourceGroup -Name 'az30304*'
   ```

    > **注**: このラボで作成したリソース グループのみが出力に含まれていることを確認します。このグループは、このタスクで削除されます。

1. 「Cloud Shell」 ウィンドウから次を実行して、このラボで作成したリソース グループを削除します

   ```powershell
   Get-AzResourceGroup -Name 'az30304*' | Remove-AzResourceGroup -Force -AsJob
   ```

1. 「Cloud Shell」 ペインを閉じます。
